openapi: 3.0.3
info:
  title: ID Gateway Auth API
  version: 0.1.0
  description: |
    OpenAPI specification for the ID Gateway authentication endpoints.

    The API follows an OAuth2-style authorization code flow (OIDC-lite) with
    endpoints for initiating authorization, exchanging authorization codes for
    tokens, and fetching user information for an authenticated session.
servers:
  - url: http://localhost:8080
    description: Local development server
paths:
  /auth/authorize:
    post:
      security: []
      summary: Initiate authorization by email
      description: |
        Starts an authorization session for a user. If the email does not exist
        the user record is created automatically. Returns an authorization code
        and the redirect URI that should be used by the caller.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthorizationRequest"
            examples:
              default:
                summary: Minimal authorize request
                value:
                  email: user@example.com
                  client_id: demo-client
                  scopes: ["openid", "profile"]
                  redirect_uri: https://app.example.com/callback
                  state: abc123
      responses:
        "200":
          description: Authorization created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthorizationResponse"
              examples:
                default:
                  value:
                    code: authz_cafedeadbeef
                    redirect_uri: https://app.example.com/callback
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
  /auth/token:
    post:
      security: []
      summary: Exchange code or refresh token for new tokens
      description: |
        Exchanges a valid authorization code (FR-1) or refresh token (FR-2)
        for new tokens. For authorization code exchange, the `redirect_uri`
        and `client_id` must match the authorize request. For refresh grant,
        provide a valid refresh token and the `client_id`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "#/components/schemas/TokenRequestAuthCode"
                - $ref: "#/components/schemas/TokenRequestRefresh"
            examples:
              default:
                value:
                  grant_type: authorization_code
                  code: authz_cafedeadbeef
                  redirect_uri: https://app.example.com/callback
                  client_id: demo-client
              refresh_grant:
                value:
                  grant_type: refresh_token
                  refresh_token: ref_7c9e6679-7425-40de-944b-e07fc1f90ae7
                  client_id: demo-client
      responses:
        "200":
          description: Tokens issued successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
              examples:
                default:
                  value:
                    access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    id_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    refresh_token: ref_7c9e6679-7425-40de-944b-e07fc1f90ae7
                    token_type: Bearer
                    expires_in: 3600
                    scope: openid profile
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
  /auth/revoke:
    post:
      summary: Revoke access or refresh token (logout)
      security: []
      description: |
        Implements RFC 7009 token revocation (FR-3). Accepts either access
        token (JWT) or refresh token (opaque). Idempotent.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RevokeRequest"
            examples:
              refresh:
                value:
                  token: ref_7c9e6679-7425-40de-944b-e07fc1f90ae7
                  token_type_hint: refresh_token
      responses:
        "200":
          description: Revocation succeeded or token already invalid
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RevokeResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"
  /auth/sessions:
    get:
      summary: List active sessions for current user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Active sessions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
  /auth/sessions/{session_id}:
    delete:
      summary: Revoke a specific session by ID
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: session_id
          required: true
          schema:
            type: string
          description: Target session identifier
      responses:
        "200":
          description: Session revoked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RevokeSessionResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Forbidden â€” session does not belong to user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalError"
  /auth/logout-all:
    post:
      summary: Revoke all sessions for current user
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: except_current
          required: false
          schema:
            type: boolean
            default: true
          description: Keep the current session active when true
      responses:
        "200":
          description: Global logout completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogoutAllResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
  /auth/userinfo:
    get:
      summary: Get user information for the authenticated session
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User info for the session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserInfo"
              examples:
                default:
                  value:
                    sub: 7d3e1c6e-7e1c-4b3c-9d7d-31a322b2fbfb
                    email: user@example.com
                    email_verified: true
                    given_name: Jane
                    family_name: Doe
                    name: Jane Doe
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    AuthorizationRequest:
      type: object
      required: [email, client_id, scopes, redirect_uri]
      properties:
        email:
          type: string
          format: email
          description: User email to authorize or create
          maxLength: 255
        client_id:
          type: string
          description: OAuth client identifier
          minLength: 3
          maxLength: 100
        scopes:
          type: array
          minItems: 1
          description: Scopes requested for the session
          items:
            type: string
            description: Requested scope value
        redirect_uri:
          type: string
          format: uri
          description: Redirect URI to return users after authorization
          maxLength: 2048
        state:
          type: string
          description: Opaque value used to maintain state between request and callback
          maxLength: 500
    AuthorizationResponse:
      type: object
      required: [code, redirect_uri]
      properties:
        code:
          type: string
          description: Authorization code for token exchange
        redirect_uri:
          type: string
          format: uri
          description: Redirect URI to invoke after successful authorization
    TokenRequestAuthCode:
      type: object
      required: [grant_type, code, redirect_uri, client_id]
      properties:
        grant_type:
          type: string
          enum: [authorization_code]
          description: Must be `authorization_code`
        code:
          type: string
          description: Authorization code received from `/auth/authorize`
        redirect_uri:
          type: string
          format: uri
          description: Redirect URI that matches the authorize call
        client_id:
          type: string
          description: OAuth client identifier used during authorization
    TokenRequestRefresh:
      type: object
      required: [grant_type, refresh_token, client_id]
      properties:
        grant_type:
          type: string
          enum: [refresh_token]
          description: Must be `refresh_token`
        refresh_token:
          type: string
          description: Opaque refresh token issued previously
        client_id:
          type: string
          description: OAuth client identifier
    TokenResponse:
      type: object
      required: [access_token, id_token, expires_in]
      properties:
        access_token:
          type: string
          description: Access token for authenticated requests
        id_token:
          type: string
          description: ID token containing authenticated user claims
        refresh_token:
          type: string
          description: New refresh token when using refresh grant (rotation); also issued on initial exchange
        token_type:
          type: string
          description: Token type indicator; always "Bearer"
          example: Bearer
        expires_in:
          type: integer
          description: Token expiration in seconds
          minimum: 1
          example: 3600
        scope:
          type: string
          description: Space-delimited scopes granted
          example: openid profile
    RevokeRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string
          description: Token to revoke (access or refresh)
        client_id:
          type: string
          description: OAuth client identifier (optional per RFC 7009, required for public clients)
        token_type_hint:
          type: string
          enum: [access_token, refresh_token]
          description: Optional hint for token type
    RevokeResponse:
      type: object
      required: [revoked]
      properties:
        revoked:
          type: boolean
        message:
          type: string
    SessionsResponse:
      type: object
      properties:
        sessions:
          type: array
          items:
            $ref: "#/components/schemas/SessionItem"
    SessionItem:
      type: object
      properties:
        session_id:
          type: string
          description: Unique session identifier
        device:
          type: string
          description: Display-safe device label
        location:
          type: string
          description: Display-safe approximate location
        created_at:
          type: string
          format: date-time
          description: Timestamp when the session was created
        last_activity:
          type: string
          format: date-time
          description: Timestamp of last session activity
        is_current:
          type: boolean
          description: True if this is the session making the request
    RevokeSessionResponse:
      type: object
      properties:
        revoked:
          type: boolean
        session_id:
          type: string
        message:
          type: string
    LogoutAllResponse:
      type: object
      properties:
        revoked_count:
          type: integer
        message:
          type: string
    UserInfo:
      type: object
      required: [sub, email, email_verified]
      properties:
        sub:
          type: string
          format: uuid
          description: Subject identifier for the authenticated user
        email:
          type: string
          format: email
          maxLength: 255
          description: Preferred email address
        email_verified:
          type: boolean
          description: Indicates whether the email has been verified
        given_name:
          type: string
          maxLength: 100
          description: User's given name
        family_name:
          type: string
          maxLength: 100
          description: User's family name
        name:
          type: string
          maxLength: 100
          description: Full name
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Machine readable error code
          enum:
            [
              bad_request,
              unauthorized,
              conflict,
              not_found,
              internal_error,
              invalid_consent,
              missing_consent,
              policy_violation,
              registry_timeout,
            ]
        error_description:
          type: string
          description: Human readable explanation of the error
  responses:
    BadRequest:
      description: Invalid or malformed request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            validation_failure:
              value:
                error: bad_request
                error_description: Invalid JSON in request body
    Unauthorized:
      description: Missing or invalid credentials
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            missing_header:
              value:
                error: unauthorized
                error_description: Missing or invalid Authorization header
    InternalError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            generic:
              value:
                error: internal_error
